{{extend 'layout.html'}}

<div class="well well-small">
  <div>{{=form}}</div>
</div>

<div class="row">
  <div id="retrieve_status" class="col-sm-4"></div>
  <div id="retrieve_books" class="col-sm-8"></div>
</div>

<form method="get" action="http://info.jib.cz/informace-pro-uzivatele/firefox/deeplink" name="jib" target="_blank">
  <div style="width: 158px; height: 151px; text-align:left">
    <img src="http://info.jib.cz/obrazky/hledej.gif" usemap="#mapa" border="0">
    <input size="15" name="dotaz" style="width:128px; height:20px; position:relative; top:-58px;
    right:-15px; border:0px" type="text">
    <input name="sada" value="utf8" type="hidden">
  </div>
</form>
<map name="mapa">
  <area shape="rect" alt="hledej" coords="20,121,137,139" href="javascript:document.jib.submit();">
</map>

<script>
$(document).ready(function() {
    // get current status
    var interval = 2000;
    var resolvedQuestion = null;
    function questionStatusAndId(jqEl) {
        return (jqEl.hasClass('active') ? '+' : '-') + jqEl.attr('data_id');
    }
    function getBooksForQuestionEl(jqEl) {
        var wishQuestion = questionStatusAndId(jqEl);
        if (wishQuestion !== resolvedQuestion) {
            ajax('{{=URL('retrieve_books')}}' + '/' + wishQuestion.substr(1), [], 'retrieve_books');
        }
        return wishQuestion;
    }
    function getRetrieveStatus() {
        $.getJSON("{{=URL('retrieve_status')}}", function(result, status) {
            $('#retrieve_status .list-group-item').off('click');
            $('#retrieve_status').html(result);
            $('#retrieve_status .list-group-item').click(function(event) {
                resolvedQuestion = getBooksForQuestionEl($(event.target));
            });
        });
        window.setTimeout(getRetrieveStatus, interval);
        interval = 1.2 * interval;  // make server load less for the page without user interaction
    }
    getRetrieveStatus();
    var wishList = $('.list-group-item');
    if (wishList) {
        resolvedQuestion = getBooksForQuestionEl(wishList[0]);
    }
});
</script>
